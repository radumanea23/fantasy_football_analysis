<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Power Rankings ‚Äì 2025 Week 1</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <nav class="nav">
      <div class="nav-inner">
        <div class="brand">Sean Farrell's Carpool</div>
        <a href="./power-rankings.html">Power Rankings</a>
        <a href="./matchups.html">Matchups</a>
        <a href="./analytics.html">Analytics</a>
        <div class="spacer"></div>
        <span id="week-button" class="badge button">2025 ‚Ä¢ Week 2</span>
        <button id="theme-toggle" class="btn" aria-label="Toggle theme" title="Toggle theme">‚òÄÔ∏è</button>
      </div>
    </nav>
    <div id="week-pop" class="popover" style="display:none;"></div>
    <div class="container">
      <div class="card">
        <h1 class="title">Power Rankings</h1>
        <p class="muted">Tap a team to expand analysis</p>
        <div id="rankings" class="rankings"></div>
      </div>
    </div>
    <script>
      (function initTheme(){
        const stored = localStorage.getItem('theme') || 'light';
        if (stored === 'dark') document.documentElement.setAttribute('data-theme','dark');
        const btn = document.getElementById('theme-toggle');
        const update = () => { btn.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? 'üåô' : '‚òÄÔ∏è'; };
        update();
        btn.addEventListener('click', () => {
          const curr = document.documentElement.getAttribute('data-theme');
          const next = curr === 'dark' ? null : 'dark';
          if (next) document.documentElement.setAttribute('data-theme', next); else document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('theme', next ? 'dark' : 'light');
          update();
        });
      })();
    </script>
    <script>
      (function initWeekSwitcher(){
        const btn = document.getElementById('week-button');
        const pop = document.getElementById('week-pop');
        async function buildMenu(){
          const hist = await fetch('./data/2025/history.json').then(r=>r.json()).catch(()=>({weeks:{}}));
          const weeks = Object.keys(hist.weeks||{}).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
          const latest = weeks[weeks.length-1] || 1;
          btn.textContent = `2025 ‚Ä¢ Week ${latest}`;
          pop.innerHTML = weeks.map(w=>`<a href="#" data-week="${w}">2025 ‚Ä¢ Week ${w}</a>`).join('');
          pop.querySelectorAll('a').forEach(a=>{
            a.addEventListener('click', (e)=>{
              e.preventDefault();
              const w = a.getAttribute('data-week');
              loadRankings(parseInt(w,10));
              pop.style.display = 'none';
              btn.textContent = `2025 ‚Ä¢ Week ${w}`;
            });
          });
          // Load latest by default
          loadRankings(latest);
        }
        function place(){
          const rect = btn.getBoundingClientRect();
          pop.style.top = (rect.bottom + window.scrollY + 6) + 'px';
          pop.style.left = (rect.right - 160 + window.scrollX) + 'px';
          pop.style.minWidth = '160px';
        }
        btn.addEventListener('click', ()=>{
          if (pop.style.display === 'none'){ place(); pop.style.display = 'block'; } else { pop.style.display = 'none'; }
        });
        document.addEventListener('click', (e)=>{ if (!btn.contains(e.target) && !pop.contains(e.target)) pop.style.display='none'; });
        buildMenu();
      })();
    </script>
    <footer class="footer">
      <div class="footer-inner">
        <div class="muted">¬© 2025 Sean Farrell's Carpool</div>
        <div class="footer-links">
          <a href="https://www.hudl.com/profile/8700482/Dominic-Quigley" target="_blank" rel="noopener noreferrer">Dom's huddle highlights</a>
          <a href="https://github.com/radumanea23/fantasy_football_analysis" target="_blank" rel="noopener noreferrer">Github</a>
        </div>
      </div>
    </footer>
    <script>
      async function loadRankings(week=1) {
        const cb = (u)=> u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const res = await fetch(cb(`./data/2025/week${week}/power_rankings.json`));
        const data = await res.json();
        const teamsRes = await fetch(cb('./data/teams.json'));
        const teamsData = await teamsRes.json();
        // Preload standings and history once (avoid await inside loop)
        const standingsData = await fetch(cb(`./data/2025/standings.json`))
          .then(r => r.json())
          .catch(() => ({ standings: [] }));
        const standingsMap = new Map((standingsData.standings || []).map(s => [s.roster_id, s]));
        const historyData = await fetch(cb(`./data/2025/history.json`))
          .then(r => r.json())
          .catch(() => ({ weeks: {} }));
        const rosterIdToTeam = new Map(teamsData.teams.map(t => [t.roster_id, t]));

        const container = document.getElementById('rankings');
        container.innerHTML = '';

        let expanded = null;
        function collapseAll() {
          [...container.children].forEach(c => c.classList.remove('expanded'));
        }

        function renderLinks(text) {
          if (!text) return '';
          let html = String(text);
          // Markdown links: [label](https://url)
          html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, (m, label, url) => {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
          });
          // Bare URLs
          html = html.replace(/(https?:\/\/[^\s)]+)(?![^<]*>)/g, (url) => {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
          });
          return html;
        }

        data.rankings
          .slice()
          .sort((a,b) => (a.rank||999) - (b.rank||999))
          .forEach(r => {
            const team = rosterIdToTeam.get(r.roster_id) || { team_name: r.team_name, avatar_url: '' };
            const card = document.createElement('div');
            card.className = 'rank-card';
            card.innerHTML = `
              <div class="rank-card-header" style="justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:12px;">
                  <div class="rank-num">${r.rank}</div>
                  <img class="rank-avatar" src="${team.avatar_url || ''}" alt="avatar" onerror="this.style.display='none'" />
                  <div class="rank-team">${team.team_name || r.team_name}</div>
                </div>
                <div class="rank-meta" style="display:flex;align-items:center;gap:10px;">
                  <span class="muted" data-record></span>
                  <span class="muted" data-pfpa></span>
                  <span data-delta></span>
                </div>
              </div>
              <div class="rank-expand"></div>
              <div class="rank-details">
                <div style="font-weight:600;margin-bottom:6px;">Key Players</div>
                <ul class="kp"></ul>
                <div style="font-weight:600;margin:10px 0 6px;">Bench Potential</div>
                <div class="bp"></div>
                <div style="font-weight:600;margin:10px 0 6px;">Make or Break</div>
                <div class="mb"></div>
                <div class="sources-wrap" style="margin-top:10px; display:none;">
                  <div style="font-weight:600;margin:10px 0 6px;">Sources</div>
                  <ul class="sources"></ul>
                </div>
              </div>
            `;
            card.addEventListener('click', () => {
              const details = card.querySelector('.rank-details');
              const wasExpanded = card.classList.contains('expanded');
              // Collapse others first
              [...container.children].forEach(c => {
                if (c !== card) {
                  const d = c.querySelector('.rank-details');
                  if (d) d.style.maxHeight = '0px';
                  c.classList.remove('expanded');
                }
              });
              if (wasExpanded) {
                if (details) details.style.maxHeight = '0px';
                card.classList.remove('expanded');
              } else {
                card.classList.add('expanded');
                // Measure full height then animate to avoid cutoff
                if (details) {
                  details.style.maxHeight = 'none';
                  const full = details.scrollHeight;
                  details.style.maxHeight = '0px';
                  requestAnimationFrame(() => {
                    details.style.maxHeight = full + 'px';
                  });
                }
              }
            });
            container.appendChild(card);
            // Populate summary (with linkification if URLs present)
            const summaryEl = card.querySelector('.rank-expand');
            if (summaryEl) summaryEl.innerHTML = renderLinks(r.summary || 'Expand for analysis');

            // Populate details if present
            const details = card.querySelector('.rank-details');
            const kp = details ? details.querySelector('.kp') : null;
            const bp = details ? details.querySelector('.bp') : null;
            const mb = details ? details.querySelector('.mb') : null;
            const sourcesWrap = details ? details.querySelector('.sources-wrap') : null;
            const sourcesList = details ? details.querySelector('.sources') : null;
            const analysis = r.analysis || {};
            if (kp && Array.isArray(analysis.key_players)) {
              analysis.key_players.forEach(k => {
                const li = document.createElement('li');
                li.innerHTML = `${k.name}: ${renderLinks(k.note)}`;
                kp.appendChild(li);
              });
            }
            if (bp) bp.innerHTML = renderLinks(analysis.bench_potential || '');
            if (mb) mb.innerHTML = renderLinks(analysis.make_or_break || '');

            // Optional sources field: array of strings or objects {title,url}
            if (sourcesList && Array.isArray(r.sources) && r.sources.length) {
              if (sourcesWrap) sourcesWrap.style.display = 'block';
              r.sources.forEach(s => {
                const li = document.createElement('li');
                if (typeof s === 'string') {
                  li.innerHTML = `<a href="${s}" target="_blank" rel="noopener noreferrer">${s}</a>`;
                } else if (s && s.url) {
                  const title = s.title || s.url;
                  li.innerHTML = `<a href="${s.url}" target="_blank" rel="noopener noreferrer">${title}</a>`;
                }
                sourcesList.appendChild(li);
              });
            }

            // Enrich header meta: record, PF/PA, rank delta
            const s = standingsMap.get(r.roster_id) || {wins:0,losses:0,ties:0,pf:0,pa:0};
            const recEl = card.querySelector('[data-record]');
            const pfpaEl = card.querySelector('[data-pfpa]');
            if (recEl) recEl.textContent = `${s.wins}-${s.losses}${s.ties?('-'+s.ties):''}`;
            if (pfpaEl) pfpaEl.textContent = `PF ${s.pf} ‚Ä¢ PA ${s.pa}`;

            const hist = historyData;
            const deltaEl = card.querySelector('[data-delta]');
            let deltaText = '‚Äì'; let color = 'var(--muted)';
            try {
              const weeks = hist.weeks || {};
              const weekNums = Object.keys(weeks).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
              if (weekNums.length >= 2) {
                const lastWeek = weekNums[weekNums.length-2];
                const prev = (weeks[String(lastWeek)]||[]).find(x=>x.roster_id===r.roster_id);
                if (prev && typeof prev.rank==='number') {
                  const delta = prev.rank - r.rank; // positive if moved up
                  if (delta > 0) { deltaText = `‚ñ≤ ${delta}`; color = '#16a34a'; }
                  else if (delta < 0) { deltaText = `‚ñº ${Math.abs(delta)}`; color = '#dc2626'; }
                  else { deltaText = '‚ñ† 0'; color = 'var(--muted)'; }
                } else { deltaText = '‚ñ† 0'; }
              } else { deltaText = '‚ñ† 0'; }
            } catch(e) { deltaText = '‚ñ† 0'; }
            if (deltaEl) { deltaEl.textContent = deltaText; deltaEl.style.color = color; }
          });
      }
      loadRankings();
    </script>
  </body>
  </html>


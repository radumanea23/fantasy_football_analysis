<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Analytics ‚Äì Power Rankings Trend</title>
    <link rel="stylesheet" href="./styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <nav class="nav">
      <div class="nav-inner">
        <div class="brand">Sean Farrell's Carpool</div>
        <a href="./power-rankings.html">Power Rankings</a>
        <a href="./matchups.html">Matchups</a>
        <a href="./analytics.html">Analytics</a>
        <div class="spacer"></div>
        <span id="week-button" class="badge button">2025 ‚Ä¢ Week 1</span>
        <button id="theme-toggle" class="btn" aria-label="Toggle theme" title="Toggle theme">‚òÄÔ∏è</button>
      </div>
    </nav>
    <div id="week-pop" class="popover" style="display:none;"></div>
    <div class="container">
      <div class="card">
        <h1 class="title">Power Rankings ‚Äì Trend</h1>
        <p class="muted">Scatter: x = week, y = rank (hover for team)</p>
        <canvas id="chart" height="120"></canvas>
      </div>
    </div>
    <script>
      (function initTheme(){
        const stored = localStorage.getItem('theme') || 'light';
        if (stored === 'dark') document.documentElement.setAttribute('data-theme','dark');
        const btn = document.getElementById('theme-toggle');
        const update = () => { btn.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? 'üåô' : '‚òÄÔ∏è'; };
        update();
        btn.addEventListener('click', () => {
          const curr = document.documentElement.getAttribute('data-theme');
          const next = curr === 'dark' ? null : 'dark';
          if (next) document.documentElement.setAttribute('data-theme', next); else document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('theme', next ? 'dark' : 'light');
          update();
        });
      })();
    </script>
    <script>
      (function initWeekSwitcher(){
        const btn = document.getElementById('week-button');
        const pop = document.getElementById('week-pop');
        const cb = (u)=> u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();
        // Ensure Chart is available; if not, attempt to load UMD build
        async function ensureChart(){
          if (typeof window !== 'undefined' && typeof window.Chart !== 'undefined') return;
          await new Promise((resolve)=>{
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
            s.async = true;
            s.onload = resolve;
            s.onerror = resolve; // resolve anyway; renderChart has guards
            document.head.appendChild(s);
          });
        }
        async function buildMenu(){
          let hist = {weeks:{}};
          try { hist = await fetch(cb('./data/2025/history.json')).then(r=>r.json()); } catch(e) {}
          const weeks = Object.keys(hist.weeks||{}).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
          const latest = weeks[weeks.length-1] || 1;
          btn.textContent = `2025 ‚Ä¢ Week ${latest}`;
          pop.innerHTML = weeks.map(w=>`<a href="#" data-week="${w}">2025 ‚Ä¢ Week ${w}</a>`).join('');
          pop.querySelectorAll('a').forEach(a=>{
            a.addEventListener('click', (e)=>{
              e.preventDefault();
              const w = parseInt(a.getAttribute('data-week'),10);
              btn.textContent = `2025 ‚Ä¢ Week ${w}`;
              renderChart();
              pop.style.display = 'none';
            });
          });
          // ensure initial render uses latest
          await ensureChart();
          renderChart();
        }
        function place(){ const r = btn.getBoundingClientRect(); pop.style.top=(r.bottom+window.scrollY+6)+'px'; pop.style.left=(r.right-160+window.scrollX)+'px'; pop.style.minWidth='160px'; }
        btn.addEventListener('click', ()=>{ if(pop.style.display==='none'){place();pop.style.display='block';} else {pop.style.display='none';}});
        document.addEventListener('click', (e)=>{ if(!btn.contains(e.target)&&!pop.contains(e.target)) pop.style.display='none';});
        buildMenu();
      })();

      async function renderChart(){
        const cb = (u)=> u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const hasChart = typeof window !== 'undefined' && typeof window.Chart !== 'undefined';
        try {
          const hist = await fetch(cb('./data/2025/history.json')).then(r=>r.json());
          const weeks = Object.keys(hist.weeks||{}).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
          // Build one dataset per team, connecting their ranks across weeks
          const datasetsMap = new Map();
          weeks.forEach(function(w){
            (hist.weeks[String(w)]||[]).forEach(function(r){
              var rid = r.roster_id;
              var ds = datasetsMap.get(rid);
              if (!ds) {
                var hue = (rid * 31) % 360;
                ds = {
                  label: r.team_name || ('Team ' + rid),
                  data: [],
                  showLine: true,
                  fill: false,
                  borderColor: 'hsl(' + hue + ', 70%, 45%)',
                  backgroundColor: 'hsla(' + hue + ', 70%, 45%, 0.55)',
                  pointRadius: 3,
                  pointHoverRadius: 5,
                  borderWidth: 2,
                  tension: 0
                };
                datasetsMap.set(rid, ds);
              }
              ds.data.push({ x: w, y: r.rank });
            });
          });
          const datasets = Array.from(datasetsMap.values());
          const ctx = document.getElementById('chart').getContext('2d');
          if (window.__chart) { window.__chart.destroy(); }
          if (!hasChart) { return; }
          window.__chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
              responsive: true,
              parsing: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(context){
                      var dsLabel = (context && context.dataset && context.dataset.label) ? context.dataset.label : 'Team';
                      var x = context && context.parsed ? context.parsed.x : '';
                      var y = context && context.parsed ? context.parsed.y : '';
                      return dsLabel + ' ‚Äì week ' + x + ', rank ' + y;
                    }
                  }
                }
              },
              scales: {
                x: {
                  type: 'linear',
                  min: 1,
                  max: 17,
                  ticks: {
                    stepSize: 1,
                    callback: function(v){ return v; }
                  }
                },
                y: {
                  reverse: true,
                  min: 1,
                  max: 12,
                  ticks: { stepSize: 1 }
                }
              }
            }
          });
        } catch (e) {
          const ctx = document.getElementById('chart').getContext('2d');
          if (window.__chart) { window.__chart.destroy(); }
          if (!hasChart) { return; }
          window.__chart = new Chart(ctx, {
            type:'scatter',
            data:{datasets:[]},
            options:{responsive:true}
          });
        }
      }
      // initial render gets called in week switcher once latest week computed
    </script>
    <footer class="footer">
      <div class="footer-inner">
        <div class="muted">¬© 2025 Sean Farrell's Carpool</div>
        <div class="footer-links">
          <a href="https://www.hudl.com/profile/8700482/Dominic-Quigley" target="_blank" rel="noopener noreferrer">Dom's huddle highlights</a>
          <a href="https://github.com/radumanea23/fantasy_football_analysis" target="_blank" rel="noopener noreferrer">Github</a>
        </div>
      </div>
    </footer>
  </body>
  </html>

